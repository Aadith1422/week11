# 🦠 Malware (Malicious Software) — Detailed Write‑Up

> **Short abstract:** Malware is any software intentionally designed to damage systems, steal data, spy on users, extort money, or provide unauthorized access. Defending against it requires layered controls across people, process, and technology.

---

## Table of Contents
1. [Definition & Threat Landscape](#definition--threat-landscape)
2. [Taxonomy: Major Malware Families](#taxonomy-major-malware-families)
3. [Infection Vectors (How Malware Gets In)](#infection-vectors-how-malware-gets-in)
4. [Execution, Persistence & Privilege Escalation](#execution-persistence--privilege-escalation)
5. [Evasion, Obfuscation & “Living off the Land”](#evasion-obfuscation--living-off-the-land)
6. [Command-and-Control (C2) & Data Exfiltration](#command-and-control-c2--data-exfiltration)
7. [Modern Trends (Fileless, Mobile, IoT, Cloud, Supply Chain)](#modern-trends-fileless-mobile-iot-cloud-supply-chain)
8. [Detection & Analysis](#detection--analysis)
9. [Incident Response: Contain, Eradicate, Recover](#incident-response-contain-eradicate-recover)
10. [Hardening & Prevention Checklist](#hardening--prevention-checklist)
11. [Indicators of Compromise (IOCs) & YARA Example](#indicators-of-compromise-iocs--yara-example)
12. [Case Studies (WannaCry, NotPetya, Emotet)](#case-studies-wannacry-notpetya-emotet)
13. [Quick Reference (Useful Events/Commands/Tools)](#quick-reference-useful-eventscommandstools)
14. [Glossary](#glossary)
15. [Further Reading](#further-reading)

---

## Definition & Threat Landscape

**Malware** (malicious software) is software created to **disrupt operations**, **exfiltrate data**, **extort victims**, **spy on users**, or **establish unauthorized control** over devices and networks. It targets Windows, Linux, macOS, mobile OSs (Android/iOS), network appliances, cloud services, and even industrial control systems.

**Why it matters:** Malware underpins many modern attacks—business email compromise, ransomware, data breaches, crypto‑mining, and espionage. The threat landscape ranges from commodity “spray-and-pray” campaigns to highly targeted, well-resourced operations.

---

## Taxonomy: Major Malware Families

- **Virus:** Attaches to host files and propagates when that file runs. Often modifies or corrupts other files.
- **Worm:** Self‑replicates across networks without user action (e.g., exploiting a network service).
- **Trojan:** Masquerades as legitimate software (e.g., “free PDF converter”) but performs malicious actions.
- **Ransomware:** Encrypts data or locks systems and demands payment for decryption/unlock.
- **Spyware / Infostealer:** Steals credentials, browser cookies, autofill data, crypto wallets, screenshots, or keystrokes.
- **Backdoor / RAT (Remote Access Trojan):** Gives remote control to an attacker for persistence and data access.
- **Rootkit / Bootkit:** Hides processes and files; may infect kernel, drivers, bootloader, or firmware.
- **Botnet / DDoS Agent:** Enrolls devices into a centrally controlled swarm for attacks like DDoS or spam.
- **Wiper:** Destroys data (irreversible), often disguised as ransomware.
- **Cryptominer:** Hijacks compute resources to mine cryptocurrency.
- **Mobile Malware:** SMS fraud, banking trojans, stalkerware, sideloaded APKs, malicious profiles/mobile MDM abuse.

> Note: Real-world families are often **hybrids** (e.g., trojan with RAT capabilities + infostealer module).

---

## Infection Vectors (How Malware Gets In)

- **Phishing/Smishing:** Malicious attachments (macros, HTA, LNK), links to drive‑by pages, credential harvesting.
- **Drive‑By Download / Exploit Kits:** Compromised or malicious sites exploit browser/plug‑in/OS flaws.
- **Malvertising:** Ads that redirect to exploit kits or trick users into downloads.
- **Removable Media:** Infected USBs leveraging autorun or user curiosity (“HR‑Salary.xlsx.lnk”).
- **RDP/SSH Exposure & Brute Force:** Weak or reused credentials; public remote services.
- **Software Vulnerabilities:** Unpatched services (e.g., SMB, VPN appliances, web apps, deserialization bugs).
- **Supply‑Chain:** Compromised vendor updates, third‑party packages, poisoned installers.
- **Watering Hole:** Target’s frequented site compromised to deliver tailored exploits.
- **Lateral Movement from BYOD or Home Networks:** Infected personal devices pivoting into corporate networks.

---

## Execution, Persistence & Privilege Escalation

### Typical Kill Chain (High Level)
```
[Initial Access] → [Execution] → [Persistence] → [Privilege Escalation] → [Discovery] → [Lateral Movement] → [Collection] → [Exfiltration] → [Impact]
```

### Common Techniques
- **Execution:** Office macros, script interpreters (PowerShell, wscript, bash), LOLBins (rundll32, mshta), exploit of vulnerable services, DLL search order hijacking, scheduled tasks.
- **Persistence (Windows):** Run/RunOnce keys, Services, Scheduled Tasks, Startup folders, WMI event subscriptions, AppInit_DLLs, Image File Execution Options (IFEO), COM hijacking, LSASS dumping for credentials.
- **Persistence (Linux/macOS):** `crontab`, `systemd` services, `~/.config/autostart`, `launchd` (macOS), shell profile files, malicious kernel modules/kexts.
- **Privilege Escalation:** Exploiting local privilege escalation (LPE) CVEs, token manipulation, UAC bypass, set‑uid binaries, abusing misconfigurations.

---

## Evasion, Obfuscation & “Living off the Land”

- **Packers/Obfuscators:** UPX/custom packers, string encryption, control‑flow flattening.
- **Polymorphism/Metamorphism:** Code mutates per infection to evade signatures.
- **Process Injection:** DLL injection, process hollowing, thread APC injection, reflective DLL loading.
- **Fileless Techniques:** WMI, PowerShell in-memory, registry‑only payloads, script blocks.
- **LOLbins/LOLBAS:** Abuse of built‑in binaries (e.g., `certutil`, `bitsadmin`, `powershell`, `regsvr32`, `rundll32`) to blend with normal activity.
- **Defense Evasion:** Disabling AV, tampering with EDR, clearing logs, timestomping, signed binary proxy execution.
- **Network Evasion:** TLS, domain fronting, DNS tunneling, use of cloud services (paste sites, storage buckets, chat apps) for C2 and drops.

---

## Command-and-Control (C2) & Data Exfiltration

- **C2 Channels:** HTTP/S polling, WebSockets, DNS, SMTP/IMAP, Tor, peer‑to‑peer (P2P), social media APIs, cloud storage.
- **Tasking & Beacons:** Beacons check in at intervals; C2 pushes tasks (download module, run command, exfil).
- **Exfiltrate Data:** Direct to C2 over TLS, DNS TXT records, cloud drives, or via staging hosts inside the victim network.
- **Resilience:** Multiple fallback domains, DGA (Domain Generation Algorithms), fast‑flux, dead‑drop resolvers.

---

## Modern Trends (Fileless, Mobile, IoT, Cloud, Supply Chain)

- **Fileless & LOL:** In‑memory only payloads; heavy use of PowerShell/WMI; harder to detect with file scanning.
- **Mobile:** Banking trojans, overlay attacks, malicious profiles/MDM, sideloaded APKs, zero‑click exploits in messaging stacks.
- **IoT/OT:** Weak defaults and exposed services fuel botnets (e.g., Mirai variants). OT malware targets industrial protocols.
- **Cloud:** Credential theft for IAM roles, abuse of metadata services, persistence via serverless functions, malicious containers, supply‑chain in CI/CD.
- **Supply Chain:** Compromised updates or libraries can distribute malware at scale; code signing abuse.

---

## Detection & Analysis

**Data Sources:**
- Endpoint telemetry (EDR), Windows Event Logs, Sysmon, Linux auditd, macOS Unified Logs.
- Network sensors (IDS/IPS, Zeek, Suricata), DNS logs, proxy logs, cloud audit logs (CloudTrail, GCP Audit, Azure Activity).

**Static Analysis (no execution):**
- File hashes (MD5/SHA‑256), headers, import tables, strings, packer detection.
- Sandboxing the sample offline (detonation in isolated environment).

**Dynamic Analysis (execute in sandbox):**
- Observe process tree, file/registry changes, network connections, mutexes, memory artifacts.

**Memory Forensics (post‑compromise):**
- Dump memory and analyze with tools (e.g., Volatility) to extract injected code, network connections, credentials in LSASS (Windows).

**Detection Approaches:**
- **Signatures:** AV/IDS rules; fast but brittle against mutation.
- **Heuristics/Behavioral:** Process ancestry anomalies, suspicious LOLBins misuse, unusual persistence, abnormal beacons.
- **Machine Learning:** Classify based on features; requires tuning and careful validation.
- **Threat Intel:** IOCs (domains, IPs, hashes), TTPs mapped to MITRE ATT&CK for durable detections.

---

## Incident Response: Contain, Eradicate, Recover

1. **Preparation:** Backups, EDR, logging, playbooks, contacts, exercises.
2. **Identification:** Validate alerts, scope affected hosts/accounts/data.
3. **Containment:**
   - *Short‑term:* Isolate hosts, block C2, disable compromised accounts.
   - *Long‑term:* Network segmentation, golden image builds, staged patching.
4. **Eradication:** Remove malware, revoke tokens/keys, patch vulnerabilities, reset credentials, clean persistence.
5. **Recovery:** Restore from known‑good backups, monitor closely, phased reconnect.
6. **Post‑Incident:** Lessons learned, control gaps, tabletop exercises, update detections and playbooks.

> **Ransomware tip:** Prioritize safety of backups (immutable/offline), test restores regularly, and ensure egress filtering + app allow‑listing to reduce blast radius.

---

## Hardening & Prevention Checklist

- **People & Process**
  - Security awareness (phishing drills), privileged access management, change control.
- **Identity**
  - MFA everywhere, conditional access, password managers, disable legacy auth, least privilege.
- **Endpoint**
  - EDR with tamper protection, application allow‑listing (WDAC/AppLocker), disable macros by default, patch OS/apps, disable autorun.
- **Network**
  - Segment critical assets, block outbound by default (egress filtering), DNS security (sinkhole), secure RDP/VPN (MFA + no direct Internet exposure), email security gateway.
- **Server & Cloud**
  - Harden baselines (CIS), infrastructure as code scanning, rotate keys/secrets, restrict metadata service, enforce logging.
- **Data**
  - Encrypt at rest/in transit, DLP where appropriate, maintain immutable/offline backups and test restores.
- **Monitoring**
  - Centralize logs (SIEM), behavioral alerts, threat intel feeds, regular purple teaming.

---

## Indicators of Compromise (IOCs) & YARA Example

**Common IOC types:**
- **Host:** Filenames/paths, mutex names, registry keys, services, scheduled tasks, autoruns.
- **Network:** Domains, IPs, URI paths, JA3/JA3S TLS fingerprints, unusual beacon intervals.
- **File:** Hashes (SHA‑256 preferred), code‑signing certificate anomalies.
- **Behavioral:** LOLBin patterns, suspicious parent/child process chains, unexpected remote threads.

**Sample YARA Rule (generic & safe placeholder):**
```yara
rule Suspicious_LOLBIN_Pattern
{
  meta:
    description = "Detects suspicious use of LOLBins in scripts/binaries (example)"
    author = "Analyst"
    reference = "Training use only"
  strings:
    $s1 = "rundll32 url.dll,FileProtocolHandler" nocase
    $s2 = "powershell -nop -w hidden" nocase
    $s3 = "regsvr32 /s /n /u /i:" nocase
  condition:
    any of ($s*)
}
```

> Use YARA carefully and test in a lab before production deployment to avoid false positives.

---

## Case Studies (WannaCry, NotPetya, Emotet)

- **WannaCry (2017):** Ransomware worm exploiting SMBv1 (EternalBlue). Spread rapidly across unpatched Windows systems; emphasized urgency of patching and disabling legacy protocols.
- **NotPetya (2017):** Began as a supply‑chain update compromise; behaved like ransomware but functioned as a wiper, causing massive business disruption.
- **Emotet (2014–2021, resurging later):** Started as banking malware; evolved into a modular loader used to drop other payloads (e.g., TrickBot, ransomware), delivered mainly via phishing.

---

## Quick Reference (Useful Events/Commands/Tools)

**Windows Event IDs (examples):**
- **4688** Process creation, **4624/4625** Logon success/failure, **4672** Special privileges assigned, **4698** Scheduled task created, **7045** Service installed, **4104** PowerShell script block logging (enable!), **5156** Firewall allowed connection, **1–24** Sysmon events (if deployed).

**Windows (read‑only triage commands):**
```powershell
# Autoruns and persistence (read-only collection examples)
Get-ItemProperty 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Run'          | Format-List
Get-ItemProperty 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Run'          | Format-List
schtasks /query /fo LIST /v
wmic startup get caption,command
tasklist /v
netstat -abno
Get-WinEvent -LogName Microsoft-Windows-PowerShell/Operational -MaxEvents 50
```

**Linux/macOS (read‑only triage commands):**
```bash
# Processes, network, autoruns (read-only collection examples)
ps aux
ss -tupna || netstat -tupna
crontab -l; ls -la /etc/cron.* /var/spool/cron
systemctl list-timers; systemctl list-unit-files | grep enabled
lsof -i
last -a | head
```

**Helpful Tools (defensive):** Microsoft Defender + ASR rules, Sysinternals (Autoruns, Process Explorer), OSQuery, Velociraptor, Volatility, ClamAV, Suricata, Zeek, YARA, KAPE, DFIR‑Orc, Autopsy, Wireshark.

---

## Glossary

- **IOC:** Discrete artifact that indicates potential compromise (hash, domain, registry key).
- **TTP:** Tactics, techniques, and procedures—attacker behavior patterns (see MITRE ATT&CK).
- **EDR:** Endpoint Detection & Response—agent that records/blocks suspicious activity.
- **Sandbox:** Isolated environment to execute and observe malware safely.
- **LOLBin:** Legitimate binary abused for malicious purposes.
- **DGA:** Domain Generation Algorithm—creates many domains for resilient C2.
- **Packers/Obfuscators:** Transform binaries to hinder analysis or AV detection.

---

## Further Reading

- **NIST SP 800‑61 r2:** Computer Security Incident Handling Guide.
- **MITRE ATT&CK:** Knowledge base of adversary TTPs.
- **CISA & CERT Advisories:** Timely alerts and hardening guidance.
- **CIS Benchmarks:** Secure configuration baselines.
- **Windows SecOps docs / Sysinternals:** Practical endpoint defense references.

---

### Summary (One‑minute recap)
Malware encompasses a wide range of threats—from ransomware and infostealers to fileless attacks. Focus on **prevention** (patching, MFA, segmentation, least privilege), **detection** (EDR + logging + behavior analytics), and **response** (contain → eradicate → recover). Maintain **tested, offline/immutable backups** and continuously **train users** and **refine playbooks**.